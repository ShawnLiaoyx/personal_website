---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { byPublishedDateDesc, formatDate, uniqueValues } from '../../utils/content';

const blog = (await getCollection('blog', ({ data }) => !data.draft)).sort(byPublishedDateDesc);
const categories = uniqueValues(blog.map((entry) => entry.data.category));
const tags = uniqueValues(blog.flatMap((entry) => entry.data.tags));
---

<BaseLayout title="Blog | Yuxuan Liao" description="Technical notes and writing with category and tag filters.">
	<section class="section">
		<header class="section-header">
			<h1>Blog</h1>
			<p>Browse writing by category, tag, and keyword.</p>
		</header>

		<div class="filter-panel" id="blog-filters">
			<label>
				<span class="muted">Keyword</span>
				<input type="search" name="q" placeholder="Search titles and excerpts" />
			</label>
			<label>
				<span class="muted">Category</span>
				<select name="category">
					<option value="">All categories</option>
					{categories.map((category) => (
						<option value={category}>{category}</option>
					))}
				</select>
			</label>
			<label>
				<span class="muted">Tag</span>
				<select name="tag">
					<option value="">All tags</option>
					{tags.map((tag) => (
						<option value={tag}>{tag}</option>
					))}
				</select>
			</label>
		</div>

		<div class="card-grid" id="blog-grid">
			{blog.map((entry) => (
				<article
					class="card blog-card"
					data-title={entry.data.title.toLowerCase()}
					data-excerpt={entry.data.excerpt.toLowerCase()}
					data-category={entry.data.category.toLowerCase()}
					data-tags={entry.data.tags.join(',').toLowerCase()}
				>
					<div
						class="card-visual"
						style={`background-image:url('${entry.data.cover ?? '/images/blog-notes.svg'}')`}
					></div>
					<div class="card-body">
						<h3><a href={`/blog/${entry.slug}/`}>{entry.data.title}</a></h3>
						<p>{entry.data.excerpt}</p>
						<div class="meta-row">
							<span class="muted">{formatDate(entry.data.publishedAt)}</span>
							<span class="pill">{entry.data.category}</span>
							{entry.data.tags.slice(0, 2).map((tag) => (
								<span class="pill">{tag}</span>
							))}
						</div>
					</div>
				</article>
			))}
		</div>
		<p class="empty-state" id="blog-empty" hidden>No blog posts match these filters yet.</p>
	</section>

	<script>
		const filterRoot = document.getElementById('blog-filters');
		const cards = Array.from(document.querySelectorAll<HTMLElement>('.blog-card'));
		const empty = document.getElementById('blog-empty');
		if (filterRoot && empty) {
			const queryInput = filterRoot.querySelector<HTMLInputElement>('input[name="q"]');
			const categorySelect = filterRoot.querySelector<HTMLSelectElement>('select[name="category"]');
			const tagSelect = filterRoot.querySelector<HTMLSelectElement>('select[name="tag"]');

			const params = new URLSearchParams(window.location.search);
			if (queryInput && params.get('q')) queryInput.value = params.get('q') || '';
			if (categorySelect && params.get('category')) {
				categorySelect.value = params.get('category') || '';
			}
			if (tagSelect && params.get('tag')) tagSelect.value = params.get('tag') || '';

			const applyFilters = () => {
				const query = queryInput?.value.trim().toLowerCase() || '';
				const category = categorySelect?.value.trim().toLowerCase() || '';
				const tag = tagSelect?.value.trim().toLowerCase() || '';

				let visibleCount = 0;
				for (const card of cards) {
					const haystack = `${card.dataset.title || ''} ${card.dataset.excerpt || ''}`;
					const matchesQuery = query ? haystack.includes(query) : true;
					const matchesCategory = category ? card.dataset.category === category : true;
					const matchesTag = tag ? card.dataset.tags?.split(',').includes(tag) : true;
					const matches = Boolean(matchesQuery && matchesCategory && matchesTag);
					card.style.display = matches ? '' : 'none';
					if (matches) visibleCount += 1;
				}

				empty.hidden = visibleCount !== 0;

				const next = new URLSearchParams();
				if (query) next.set('q', query);
				if (category) next.set('category', category);
				if (tag) next.set('tag', tag);
				const queryString = next.toString();
				const nextUrl = queryString
					? `${window.location.pathname}?${queryString}`
					: window.location.pathname;
				window.history.replaceState({}, '', nextUrl);
			};

			for (const control of [queryInput, categorySelect, tagSelect]) {
				control?.addEventListener('input', applyFilters);
				control?.addEventListener('change', applyFilters);
			}
			applyFilters();
		}
	</script>
</BaseLayout>
